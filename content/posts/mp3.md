+++
banner = ""
categories = ["Multimedia", "Audio", "Computer Sience", "Mathematics"]
date = 2019-08-28T05:27:13+09:00
description = "MP3 の圧縮符号化方式の概要をとおして, 音声コーデックの基本技術を学ぶ"
images = []
menu = ""
tags = ["MPEG-1 Audio", "MP3", "PCM", "Mathematics", "Fourier Transform", "Modified Discrete Cosine Transform", "MDCT"]
title = "MP3 の圧縮符号化方式"
+++

# MP3 とは ?

## MPEG

メディアデータ (動画や音声, 画像など) は, テキストデータと比較すると非常に大きなデータサイズです. したがって, データを小さくする (圧縮する) ことは不可欠です.

そして, データを圧縮するには, 複雑な算術計算が必要になります. どのように算術計算するかによって, データの形式 (<b>コーデック</b>) が異なってきます.

<b>MPEG</b> (Moving Picture coding Experts Group) は, その計算を仕様として標準化した規格の 1 つです. MPEG では, 用途に合わせて, <b>MPEG-1</b>, <b>MPEG-2</b>, <b>MPEG-4</b> の 3 種類が標準化されています.

### MPEG-1

MPEG-1 は, テレビ電話などで利用されていた, H.261 という規格をもとにして規格化されたデータ形式です. MPEG-1 の画質は, 一般的なテレビやビデオと同程度とされています.

### MPEG-2

MPEG-2 は, MPEG-1 を改良し, 放送用として十分と言える程度の高画質を目指して規格化されました. MPEG-2 は, DVD やデジタル BS 放送などのデータ形式として, 幅広く利用されています.

### MPEG-4

MPEG-4 は, MPEG-2 よりもさらに圧縮率を向上させて, テレビ電話やインターネットなどでも利用できるように改良した規格です. MPEG-4 では, 用途によって品質を選択できるのが大きな特徴です.

## MPEG オーディオ

MPEG は映像のための <b>MPEG ビデオ</b>と, 音声のための <b>MPEG オーディオ</b>の 2 つの規格に大きく分類されます.

### MPEG-1 オーディオ

MPEG-1 オーディオでは, Layer I, Layer II, Layer III の 3 つが定義されています.

#### Layer I

Layer I は, MPEG オーディオの基礎となる技術です. 音のピッチ (周波数) を 32 分割して, 人間の聴覚には聴こえない高すぎる音や, 低すぎる音を取り除くことで, データを圧縮します.

#### Layer II

Layer II では, データのまとめかたを改良することで, Layer I よりもさらに圧縮率を高めています.

#### Layer III

Layer III では, 人間の聴覚にはノイズとして知覚されてしまう部分を修復するなどの処理を追加することで, クリアな音質を実現します. Layer III を使うと, もとのデータサイズの 1 / 10 程度までデータを圧縮できます. <b>MP3 は, この MPEG-1 オーディオ Layer III が使われています</b>.

#### Layer I - Layer III の共通点

共通点としては, 32 バンドのポリフェーズ・サブバンド・フィルタによって, 周波数を 32 分割する処理は共通しています. そして, 周波数帯域ごとに, スケール・ファクタ (信号の強さを表す指数) とビット割り当て情報 (それぞれの周波数帯域ごとに, どの程度の精度で信号を表す) によって, 可変精度でサンプルを符号化します.

#### Layer I - Layer III の相違点

サンプルするブロックのサイズ (サンプル数) が異なります. また, Layer III では, 後述する MDCT が利用されます. MDCT を利用して各バンドを 12 サンプルずつ変換 (このまとまりを<b>グラニュール</b>と呼びます) して, さらにそれを 2 つ 1 組 (このまとまりを<b>ブロック</b>と呼びます) にして処理します.

<table>
  <caption>Layer I, Layer II, Layer III の比較</caption>
  <thead>
    <tr>
      <th scope="col"></th>
      <th scope="col">Layer I</th>
      <th scope="col">Layer II</th>
      <th scope="col">Layer III</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row" style="padding-right: 8px; word-break: keep-all;">符号化データの構造</th>
      <td>ブロックごとに符号化</td>
      <td>ブロックごとに符号化</td>
      <td>ブロックごとに符号化</td>
    </tr>
    <tr>
      <th scope="row" style="padding-right: 8px; word-break: keep-all;">フィルタ・バンク</th>
      <td>32 バンド ポリフェーズ・フィルタバンク</td>
      <td>32 バンド ポリフェーズ・フィルタバンク</td>
      <td>32 バンド ポリフェーズ・フィルタバンク</td>
    </tr>
    <tr>
      <th scope="row" style="padding-right: 8px; word-break: keep-all;">サンプル化</th>
      <td>スケール・ファクタとビット割り当てをしたあと, 可変精度で符号化</td>
      <td>スケール・ファクタとビット割り当てをしたあと, 可変精度で符号化</td>
      <td>スケール・ファクタとビット割り当てをしたあと, 可変精度で符号化</td>
    </tr>
    <tr>
      <th scope="row" style="padding-right: 8px; word-break: keep-all;">1 ブロックのサイズ</th>
      <td>384 (32 x 12) サンプル</td>
      <td>1152 (32 x 36) サンプル</td>
      <td>768 (32 x 12 x 2) サンプル</td>
    </tr>
  </tbody>
</table>

### MPEG-2 オーディオ

MPEG-2 オーディオには, <b>MPEG-2/BC</b> (Backward Compatible) と <b>MPEG-2/AAC</b> (Advanced Audio Coding) の 2 つの規格があります. MPEG-2/BC の基本的な仕組みは MPEG-1 オーディオと変わりません.

MPEG-2/AAC は, 高音質・高圧縮を求めるために, MPEG-2/BC のあとに制定された規格です. MPEG-2/AAC は. 大きな音の部分に雑音を集中させたり, 一定の時間内の次のデータを予測したりすることで, データサイズ大幅に削減します (MPEG-1 オーディオ Layer I と比較して, データサイズを約 70 % にできます).

### MPEG-4 オーディオ

MPEG-4 オーディオでは, 音声の規格を用途によって, いくつか定められたものから 1 つ選択することができます. 音楽の再生に利用されるのは, <b>MPEG-2/AAC</b> と <b>TwinVQ</b> の 2 つです.

#### MPEG-2/AAC

MPEG-2 オーディオとまったく同じ方式でデータを圧縮します.

#### TwinVQ

複数のデータをまとめて, その類似性を発見するという方法でデータを圧縮します.

より一般的に利用されているのは, MPEG-2/AAC で, <b>MP4</b> と呼ばれることもあります.

# 圧縮の基本

データサイズを小さくするには, もとのデータサイズそのものを少なくして実現することがもっとも単純です. <b>サンプリング周波数と量子化ビットを小さな値にすることです</b>. しかしながら, この方法では, 音質が低下してしまいます. そこで, 音質を低下させずに, データを圧縮する技術が必要です.

## ランレングス圧縮

ランレングス圧縮とは, あるビット列において, 同じデータが続く部分の個数を数えるという方法で圧縮します. 例えば, `0000110000001` のビット列で並ぶ, 13 個のデータがあるとします. このようなデータは, 表現を変えて, 0 が 4 つ, 1 が 2 つ, 0 が 6 つ, 1 が 1 つと表現することもできます.

この方法であれば, `0000 ...` のような, 0 が 50 個並んだデータを表現するには, すべてのデータを記述しなくても, 0 が 50 個と記述することで表現可能で, データサイズを小さくすることができます.

しかしながら, 同じ値が連続しない場合は, むしろ大きくなってしまう可能性もあります. 音をデジタル化したデータの場合, 同じ値が続くことは稀なので, ランレングス圧縮はあまり効果的ではありません.

## デルタ PCM

音の場合, 急激に値が変化することは少なく, 緩やかに値が変化するという性質があります. この性質を利用して, 値そのものを保存するのではなく, 前の値との差分だけを保存するという圧縮技術が, <b>デルタ PCM</b> です.

例えば, 100, 103, 108, 114, 109, 98 という 6 個のデータがあれば, その差分を取得して, +100, +3, +5, +6, -5, -11 のように表現します.

数値が小さくなるということは, 必要なビット数が少なくなるのでデータを圧縮することができます.

## log-PCM

人間の聴覚は, 音を対数的に知覚します (<b>フェヒナーの法則</b>). 対数的に知覚するとは, 音の大きさが大きい場合には, 小さな音量変化に気づかず, 音の大きさが小さい場合には, より小さな音量変化に気づきます.

そこで, 音が小さい部分では細かく, 音が大きい部分では粗く量子化することで圧縮することができます.

## 可逆圧縮と不可逆圧縮

データの圧縮には, <b>可逆圧縮</b>と<b>不可逆圧縮</b>の 2 つに分類可能です.

可逆圧縮とは, もとのデータの変化はさせず, 展開したときに, もとのデータに合致する方式です.

不可逆圧縮とは, もとのデータを変化させ, 展開したときに, もとのデーターに完全合致しない方式です. <b>MP3 は, 不可逆圧縮が利用されています</b>.

## MP3 の仕組み

MP3 では, データを圧縮するときに, 圧縮方法をいくつか設定することができます. したがって, MP3 といっても, いくつか種類があり, どのようにしてデータを生成するかによって, 音質が異なってきます.

### サンプリング周波数

MP3 では, サンプリング周波数として, 32 kHz, 44.1 kHz, 48 kHz のいずれかを選択できます.

### ビットレート

MP3 では, 32 kbps ~ 320 kbps の範囲で設定できます.

### モード

MP3 では, モノラルとステレオのどちらでも選択可能です. モードには, 以下の 5 種類があります.

<table>
  <caption>MP3 のモード</caption>
  <thead><tr><th scope="col">モード</th><th scope="col">概要</th></tr></thead>
  <tbody>
    <tr>
      <td style="word-break: keep-all;">シングルチャンネル</td>
      <td style="padding-left: 8px;">モノラル</td>
    </tr>
    <tr>
      <td style="word-break: keep-all;">デュアルチャンネル</td>
      <td style="padding-left: 8px;">単独のモノラル信号が 2 つある. ステレオと似ているが, 必ずしも, スピーカーの左右から同時に再生されるわけではない (1 チャンネルが日本語, もう 1 チャンネルが英語の場合など) </td>
    </tr>
    <tr>
      <td style="word-break: keep-all;">ステレオ</td>
      <td style="padding-left: 8px;">左チャンネルと右チャンネルのデータが個別に入っている</td>
    </tr>
    <tr>
      <td style="word-break: keep-all;">インテンシティステレオ</td>
      <td style="padding-left: 8px;">ステレオで構成されているが, 左チャンネルと右チャンネルで, 一部の同じデータを利用して, 音量差だけでステレオ効果をだす</td>
    </tr>
    <tr>
      <td style="word-break: keep-all;">MS ステレオ</td>
      <td style="padding-left: 8px;">左チャンネルと右チャンネルの大きさの差と和を計算して, その結果でデータを圧縮する</td>
    </tr>
  </tbody>
</table>

一般的に, MP3 を音楽であつかう場合,

- サンプリング周波数 44.1 kHz
- ビットレート 128 kbps or 192 kbps
- モード MS ステレオ

で利用されることがほとんどです.

## MP3 のデータサイズ

MP3 の大きな特徴として, ビットレート固定があります. したがって, <b>128 kbps の場合, 1 分のデータは, およそ 1 MB になります</b>.

# MP3 の圧縮

MP3 では, 可能な限り音質を保ったままデータサイズを小さくするために, 以下のフローでデータの性質を調べながら, 人間の聴覚に影響がない部分だけを除去しています.

![MP3 の圧縮フロー](https://user-images.githubusercontent.com/4006693/67000836-7e785a00-f113-11e9-9213-c17c35b347c0.png)

- サブバンド分解
- フーリエ変換・(変形) 離散コサイン変換 (MDCT)
- 心理聴覚評価
- 量子化
- ハフマン符号

## サブバンド分解

MP3 で圧縮するための最初の処理です. 選択したサンプリング周波数の <b>1 / 32</b> のサンプリング周波数でサンプリングしなおします.

例えば, 44.1 kHz でサンプリングする場合には, サンプリング定理にしたがい, 22.05 kHz までのデータが含まれます. MP3 では, この周波数帯域を <b>32 分割</b>して (0 - 689.0625 Hz, 689.0625 Hz - 1378.125 Hz ... 21360.9375 Hz - 22050 Hz), それぞれの周波数帯域において, 1 / 32 のサンプリング周波数 (1375 Hz) で, 再度サンプリングしなおします.

サブバンド分解する理由は, 音には以下の特性があるからです.

- 音楽では, 周波数帯域に偏りがある
  - 振幅の小さな帯域を除去する
- 周波数によって人間の知覚できる音が違う
  - 高い周波数の場合, 音量変化には鈍感, 低い周波数の場合, 音量変化に敏感

## フーリエ変換・(変形) 離散コサイン変換 (MDCT)

時間軸に対する振幅では, どの周波数成分をあつかえばよいのかわからないので, 時間軸に対する振幅を, <b>周波数軸に対する振幅</b> (振幅スペクトル) に変換する必要があります. そのための数学的処理が, <b>フーリエ変換</b>です.

![フーリエ変換](https://user-images.githubusercontent.com/4006693/63822772-69d9da00-c98c-11e9-9870-ce3c5805cf24.gif)

しかしながら, フーリエ変換は, 数式上は $-\infty$ から $\infty$ の積分として処理するので, コンピュータで実現するためには, どこかで計算をうちきる必要があります. このうちきりにより, 元の波形に合成したときに (逆フーリエ変換), 誤差が発生し, 完全に元の波形には戻らなくなります.

$
\begin{eqnarray}
X(f) = \int\_{-\infty}^{\infty}x(t)\exp(-j2{\pi}ft)dt \quad (-\infty \leqq f \leqq \infty)
\end{eqnarray}
$

この問題を解決するために, 区間の継ぎ目を調整する様々な手法が考案されました. そのうちの 1 つが, MP3 で利用されている <b>(変形) 離散コサイン変換</b> (Modified Discrete Cosine Transform) であり, 区間を重ね合わせて誤差を小さくする手法となっています.

$
\begin{eqnarray}
X(k)=\sum\_{n=0}^{2N-1}x(n)\cos\left(\frac{{\pi}}{N}\left(n+\frac{1}{2}+\frac{N}{2}\right)\left(k+\frac{1}{2}\right)\right)
\end{eqnarray}
$

## 心理聴覚評価

心理聴覚評価は, 人間の聴覚の性質をもとに, どの周波数帯域を削ってもよいかを決定する <b>MP3 の中核</b>となるものです.

ちなみに, どの周波数成分を削除するかという判断は心理聴覚評価によって決まりますが, MP3 の仕様で定義されているものは一例であって, 規約ではないので, <b>MP3 のエンコーダによって異なります</b>. これが, エンコーダによって音質が異なる理由でもあります.

心理聴覚評価では, <b>最小可聴限界</b>と<b>マスキング効果</b>を利用して, どの音が聴こえない (聴こえにくい) のかを判断します.

### 最小可聴限界

最小可聴限界とは, 静粛時に聴くことができる音圧 (dB) の範囲のことです.

聴くことができる範囲は, 音の大きさだけではなく, 周波数によっても異なります. 人間の聴覚がもっともよく反応する周波数帯域は, 2 kHz ~ 5kHz の範囲です.

最小可聴限界を下回る音圧は聴くことができないので, データを削除することができます.

![最小可聴限界](https://user-images.githubusercontent.com/4006693/66157534-eda77600-e65e-11e9-997c-24cddcec9e82.png)

### マスキング効果

大きな音が発生しているときに, 小さな音がかき消されることはおそらくほとんどの方が経験的に知っています. これは, マスキング効果と呼ばれます. 大きな音を<b>マスカー</b>, 小さな音を<b>マスキー</b>と呼びます.

マスキング効果の影響範囲もまた, 音の大きさだけでなく, 周波数にも関係します. マスカーとマスキーは, 周波数が近いほど大きな効果を発揮します.

マスカーがおよぼす周波数範囲は, 1 kHz 以下では, 約 100 Hz の範囲内です. 1 kHz 以上になると, 周波数に比例して範囲が大きくなります.

また, マスキング効果は, 同時に音が発生したときだけとは限らず, 時間的にも持続します (持続時間は, 1 / 100 程度です). 例えば, 大きな音が発生した直後の小さな音がかき消されるのはもちろん, 小さな音が発生したあとに大きな音が発生すると, 先に発生した小さな音もかき消されます.

マスキングでかき消される小さな音は聴きとれない音なので, データを削除することができます.

![マスキング効果](https://user-images.githubusercontent.com/4006693/66158478-ee410c00-e660-11e9-882e-51f0599bfe92.png)

## 量子化

量子化では, それぞれの周波数成分の振幅に対して, 数値データを割り当てます. このとき, そのまま数値を割り当てるのではなく, 適当な値で除算して値を小さくします. どれだけ除算するかは, 心理聴覚評価によって決定されます.

心理聴覚評価では, 人間の聴覚にとって重要な周波数帯域は小さな値で除算して, そうでない周波数帯域は大きな値で除算します. そうすることで. 重要でない周波数帯域の振幅は, その値を表現するのに必要なビット数が減ります.

## ハフマン符号

ハフマン符号は, 音の圧縮だけでなく, さまざまなデータに利用される汎用的な圧縮方法です. ハフマン符号は可逆圧縮であるので, 展開したときに, もとのデータと完全に合致します (可逆圧縮). したがって, メディアデータだけではなく, テキストデータにも有効な圧縮です.

ハフマン符号を簡単に説明すると,

- 発生確率の高いものほど, 短いビット数で表現できる数値を割り当てる
- 発生確率の低いものほど, 長いビット数で表現できる数値を割り当てる

とすることで, 全体のデータを小さくすることができます.

したがって, 発生確率が偏っているケースほど, 圧縮率が高くなります. 逆のケースの場合, あまり効果はありません.
実際に, どのように値を割り当てるかは, <b>ハフマン木</b>によって決定できます.

また, MP3 では, <b>ハフマン木が仕様によって決められています</b>. したがって, 事前に発生確率を求める必要やハフマン木を生成する必要はありません.

![ハフマン木の例](https://user-images.githubusercontent.com/4006693/66167106-2d2c8d00-e674-11e9-904a-890610984b16.png)

<table>
  <caption>ハフマン木から求めたハフマン符号 (根から葉にむかって数値を並べたビット列)</caption>
  <thead><tr><th scope="col">値</th><th scope="col">ハフマン符号</th></tr></thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>000</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1</td>
    </tr>
    <tr>
      <td>4</td>
      <td>001</td>
    </tr>
    <tr>
      <td>6</td>
      <td>01</td>
    </tr>
  </tbody>
</table>

可逆圧縮は, どんなデータでも小さくすることができるわけではありません. データには, <b>エントロピー</b>という単位があり, それをこえて圧縮するともとに戻せないという限界の大きさがあります. それが, 理論的に不可能なことが, <b>シャノン</b>によって証明されています.

# リファレンス

- [わかるMP3―デジタル・サウンドの仕組みと活用法](https://www.amazon.co.jp/%E3%82%8F%E3%81%8B%E3%82%8BMP3%E2%80%95%E3%83%87%E3%82%B8%E3%82%BF%E3%83%AB%E3%83%BB%E3%82%B5%E3%82%A6%E3%83%B3%E3%83%89%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF%E3%81%A8%E6%B4%BB%E7%94%A8%E6%B3%95-I%E3%83%BB-BOOKS-%E5%A4%A7%E6%BE%A4-%E6%96%87%E5%AD%9D/dp/4777511871/ref=sr_1_5)
- [改訂版 デジタル放送教科書（上）](https://www.amazon.co.jp/%E6%94%B9%E8%A8%82%E7%89%88-%E3%83%87%E3%82%B8%E3%82%BF%E3%83%AB%E6%94%BE%E9%80%81%E6%95%99%E7%A7%91%E6%9B%B8%EF%BC%88%E4%B8%8A%EF%BC%89-%E3%82%A4%E3%83%B3%E3%83%97%E3%83%AC%E3%82%B9%E6%A8%99%E6%BA%96%E6%95%99%E7%A7%91%E6%9B%B8%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA-%E4%BA%80%E5%B1%B1-%E6%B8%89/dp/4844395033)
- [独自の音声圧縮をJavaScriptで作ってみた](https://qiita.com/as_kuya/items/8acaa265bc740d925f4c)
- [ハフマン符号](https://ja.wikipedia.org/wiki/%E3%83%8F%E3%83%95%E3%83%9E%E3%83%B3%E7%AC%A6%E5%8F%B7)
